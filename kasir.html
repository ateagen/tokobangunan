<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kasir Toko</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --green:#1fbf75;
  --green-dark:#159c5f;
  --green-soft:#e9f8f1;
  --bg:#e0f7f1;
  --white:#ffffff;
  --text:#1f2937;
  --shadow:0 10px 25px rgba(0,0,0,.08);
}
*{box-sizing:border-box;font-family:system-ui;margin:0;padding:0}
body{background:var(--bg);padding:20px;color:var(--text)}
.container{max-width:1200px;margin:auto}
.header{
  background:var(--white);
  padding:20px;
  border-radius:18px;
  box-shadow:var(--shadow);
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}
h1{color:var(--green-dark)}
.card{
  background:var(--white);
  padding:20px;
  border-radius:18px;
  box-shadow:var(--shadow);
  margin-bottom:20px;
}
input,button{padding:10px;border-radius:10px;border:1px solid #ccc;font-size:15px}
button{background:var(--green);color:white;border:none;cursor:pointer}
button:hover{background:var(--green-dark)}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:12px;text-align:center;border-bottom:1px solid #eee}
th{background:var(--green-soft)}
tr.stok-row{cursor:pointer;transition:.2s}
tr.stok-row:hover{background:var(--green-soft)}
.qty input{width:60px;text-align:center}
.loading,.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center}
.loading{background:rgba(255,255,255,.7);z-index:100}
.modal{background:rgba(0,0,0,.45);z-index:200}
.modal-box{
  background:white;padding:20px;border-radius:16px;
  max-width:420px;width:90%;text-align:center;
}
.spinner{width:50px;height:50px;border:6px solid #d1fae5;border-top:6px solid var(--green);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div class="loading" id="loading"><div class="spinner"></div></div>

<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modalTitle"></h3>
    <p id="modalMsg"></p>
    <div id="modalForm"></div>
    <div style="margin-top:12px;display:flex;gap:10px;justify-content:center">
      <button id="modalOk">OK</button>
      <button onclick="closeModal()" style="background:#ccc;color:#000">Batal</button>
    </div>
  </div>
</div>

<div class="container">

<div class="header">
  <div>
    <h1 id="namaToko">Kasir</h1>
    <small id="jam"></small>
  </div>
  <button onclick="location.href='index.html'">⬅ Kembali</button>
</div>

<div class="card">
  <button onclick="tambahPengeluaranModal()">➕ Tambah Pengeluaran</button>
  <input id="search" placeholder="Cari barang..." oninput="loadStok()" style="margin-top:10px;">
  <table>
    <thead>
      <tr><th>Barang</th><th>Harga</th><th>Stok</th></tr>
    </thead>
    <tbody id="listStok"></tbody>
  </table>
</div>

<div class="card">
  <h3>Keranjang</h3>
  <table>
    <thead>
      <tr><th>Barang</th><th>Harga</th><th>Qty</th><th>Total</th><th></th></tr>
    </thead>
    <tbody id="cart"></tbody>
  </table>
</div>

<div class="card">
  <div>Total: <b id="total">0</b></div>
  <input id="diskon" type="number" placeholder="Diskon" oninput="hitung()" style="margin-top:10px;">
  <input id="bayar" type="number" placeholder="Uang bayar" oninput="hitung()" style="margin-top:10px;">
  <div>Kembalian: <b id="kembali">0</b></div>
  <button onclick="konfirmasiBayar()" style="margin-top:10px;">BAYAR</button>
</div>

</div>

<script>
const SUPABASE_URL="https://fgoeqtyaxwccxluxdvni.supabase.co";
const SUPABASE_ANON_KEY="sb_publishable_ZXJgBsB-sswr7qblwGMnLg_p6QaXKwP";
const supabaseClient = supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

let keranjang=[], namaTokoText="TOKO";

setInterval(()=>{jam.textContent=new Date().toLocaleString()},1000);

function showLoading(v){loading.style.display=v?"flex":"none"}
function showModal(t,m,okFn,form=""){modalTitle.textContent=t;modalMsg.textContent=m;modalForm.innerHTML=form;modal.style.display="flex";if(okFn) modalOk.onclick=okFn;}
function closeModal(){modal.style.display="none"}

/* ====== Load Toko ====== */
async function loadToko(){
  const {data}=await supabaseClient.from("toko").select("nama").single();
  if(data){ namaToko.textContent=data.nama; namaTokoText=data.nama }
}

/* ====== Load Stok ====== */
async function loadStok(){
  const q=search.value||"";
  const {data}=await supabaseClient
    .from("stok")
    .select("*")
    .ilike("nama_barang","%"+q+"%")
    .order("nama_barang");

  listStok.innerHTML="";
  data.forEach(s=>{
    const tr=document.createElement("tr");
    tr.className="stok-row";
    tr.onclick=()=>tambahKeKeranjang(s);
    tr.innerHTML=`<td>${s.nama_barang}</td><td>${s.harga_jual}</td><td>${s.jumlah}</td>`;
    listStok.appendChild(tr);
  });
}

/* ====== Tambah ke Keranjang ====== */
function tambahKeKeranjang(item){
  if(item.jumlah<=0){
    if(!confirm("Stok kosong, tetap tambahkan?")) return;
  }
  const ada=keranjang.find(i=>i.id===item.id);
  if(ada) ada.qty++;
  else keranjang.push({...item,qty:1});
  renderCart();
}

/* ====== Render Keranjang ====== */
function renderCart(){
  cart.innerHTML="";
  keranjang.forEach((i,idx)=>{
    cart.innerHTML+=`
    <tr>
      <td>${i.nama_barang}</td>
      <td>${i.harga_jual}</td>
      <td>
        <button onclick="ubahQty(${idx},-1)">-</button>
        <input value="${i.qty}" onchange="setQty(${idx},this.value)">
        <button onclick="ubahQty(${idx},1)">+</button>
      </td>
      <td>${i.qty*i.harga_jual}</td>
      <td><button onclick="hapusItem(${idx})">x</button></td>
    </tr>`;
  });
  hitung();
}

function ubahQty(i,n){keranjang[i].qty=Math.max(1,keranjang[i].qty+n);renderCart();}
function setQty(i,v){keranjang[i].qty=Math.max(1,Number(v));renderCart();}
function hapusItem(i){keranjang.splice(i,1);renderCart();}

/* ====== Hitung Total ====== */
function hitung(){
  const total=keranjang.reduce((a,b)=>a+b.qty*b.harga_jual,0);
  const disk=Number(diskon.value)||0;
  const final=total-disk;
  totalEl.textContent=final;
  kembali.textContent=(Number(bayar.value)||0)-final;
}

/* ====== Konfirmasi Bayar ====== */
function konfirmasiBayar(){
  if(!keranjang.length) return showModal("Gagal","Keranjang kosong",closeModal);
  showModal("Cetak Struk","Cetak struk?",()=>{closeModal(); prosesBayar(true)},
    `<button onclick="closeModal(); prosesBayar(false)" style="background:#ccc;color:#000">Tidak</button>`
  );
}

/* ====== Proses Bayar ====== */
async function prosesBayar(cetak){
  showLoading(true);
  let totalJual=0;
  for(const i of keranjang){
    const itemTotal=i.qty*i.harga_jual;
    totalJual+=itemTotal;
    await supabaseClient.from("penjualan").insert({
      nama_barang:i.nama_barang,
      jumlah:i.qty,
      total:itemTotal
    });
    await supabaseClient.from("stok")
      .update({jumlah:i.jumlah-i.qty})
      .eq("id",i.id);
    await supabaseClient.from("log_stok").insert({
      stok_id:i.id,
      perubahan:-i.qty,
      keterangan:"Terjual"
    });
  }
  if(cetak) cetakStruk();
  keranjang=[];renderCart();
  showLoading(false);
}

/* ====== Cetak Struk RAWBT ====== */
function cetakStruk(){
  let esc="\x1B\x40"; // init
  esc+="\x1B\x74\x00"; // ASCII
  esc+="\x1B\x61\x01"+namaTokoText+"\n";
  esc+="\x1B\x61\x00";
  esc+=new Date().toLocaleString()+"\n";
  esc+="------------------------------\n";
  keranjang.forEach(i=>{
    esc+=`${i.nama_barang}\n${i.qty} x ${i.harga_jual} = ${i.qty*i.harga_jual}\n`;
  });
  esc+="------------------------------\n";
  esc+="Total   : "+totalEl.textContent+"\n";
  esc+="Diskon  : "+(diskon.value||0)+"\n";
  esc+="Bayar   : "+(bayar.value||0)+"\n";
  esc+="Kembali : "+kembali.textContent+"\n\n\n";
  esc+="\x1D\x56\x00"; // cut
  location.href="rawbt://print?text="+encodeURIComponent(esc);
}

/* ====== Tambah Pengeluaran Modal ====== */
function tambahPengeluaranModal(){
  const form=`<input id="ketPengeluaran" placeholder="Keterangan" style="margin-bottom:8px;"><input id="biayaPengeluaran" type="number" placeholder="Biaya" style="margin-bottom:8px;">`;
  showModal("Tambah Pengeluaran", "Isi keterangan & biaya", async ()=>{
    const k=ketPengeluaran.value.trim();
    const b=Number(biayaPengeluaran.value);
    if(!k||b<=0){alert("Lengkapi data");return;}
    await supabaseClient.from("pengeluaran").insert({deskripsi:k,jumlah:b});
    closeModal();
  }, form);
}

const totalEl=document.getElementById("total");
const kembali=document.getElementById("kembali");

loadToko();
loadStok();
</script>

</body>
</html>
