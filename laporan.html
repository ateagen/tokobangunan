<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Laporan Penjualan</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
  --green:#4fd1a5;
  --green-dark:#2fb389;
  --green-soft:#e9f8f2;
  --bg:#f4fbf8;
  --text:#134e3a;
  --danger:#e74c3c;
}
*{box-sizing:border-box}
body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text)}
header{
  background:var(--green);
  color:white;
  padding:16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
button{
  border:none;
  padding:10px 14px;
  border-radius:6px;
  cursor:pointer;
  background:var(--green);
  color:white;
}
button.secondary{
  background:white;
  color:var(--green-dark);
  border:1px solid var(--green-dark);
}
button.danger{background:var(--danger)}
.container{padding:16px}
.filters{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:16px;
}
button:hover{background:var(--green-dark)}

td:hover{background: rgb(16, 248, 16)}

input[type=date]{
  padding:8px;
  border-radius:6px;
  border:1px solid #ccc;
}
.table-wrap{
  background:white;
  border-radius:10px;
  overflow:auto;
  margin-bottom:24px;
}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eee}
th{background:var(--green-soft)}
.spinner{
  position:fixed;inset:0;display:none;
  align-items:center;justify-content:center;
  background:rgba(255,255,255,.7);z-index:99;
}
.spinner div{
  width:40px;height:40px;
  border:5px solid var(--green-soft);
  border-top:5px solid var(--green-dark);
  border-radius:50%;animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<header>
  <h2>Laporan Penjualan</h2>
  <button class="secondary" onclick="location.href='admin.html'">Kembali ke Admin</button>
</header>

<div class="container">
<div class="filters">
  <input type="date" id="from">
  <input type="date" id="to">
  <button onclick="loadData()">Filter</button>
  <button onclick="downloadXLS()">Download XLS</button>
  <button class="danger" onclick="hapusTransaksi('old')">Hapus > 3 Bulan</button>
  <button class="danger" onclick="hapusTransaksi('all')">Hapus Semua</button>
</div>

<h3>Tabel Total</h3>
<div class="table-wrap">
<table id="tableTotal">
<thead>
<tr>
  <th>Tanggal</th>
  <th>Total Penjualan</th>
  <th>Total Pengeluaran</th>
  <th>Subtotal</th>
  <th>Aksi</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<h3>Detail Penjualan & Pengeluaran</h3>
<div class="table-wrap">
<table id="tableDetail">
<thead>
<tr>
  <th>Tanggal</th>
  <th>Jenis</th>
  <th>Nama</th>
  <th>Jumlah</th>
  <th>Harga/Biaya</th>
  <th>Total</th>
  <th>Aksi</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<div class="spinner" id="spinner"><div></div></div>

<script>
const SUPABASE_URL="https://fgoeqtyaxwccxluxdvni.supabase.co";
const SUPABASE_ANON_KEY="sb_publishable_ZXJgBsB-sswr7qblwGMnLg_p6QaXKwP";
const db=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const spinner=document.getElementById('spinner');
function showSpinner(v){spinner.style.display=v?'flex':'none'}

let DATA_TOTAL=[], DATA_DETAIL=[];

(function(){
  const d=new Date().toISOString().split('T')[0];
  from.value=d; to.value=d;
})();

function tsStart(d){return d+"T00:00:00"}
function tsEnd(d){return d+"T23:59:59"}

async function loadData(){
  showSpinner(true);
  DATA_TOTAL=[]; DATA_DETAIL=[];

  const f=from.value,t=to.value;

  const {data:jual}=await db.from('penjualan')
    .select('*').gte('tgl',tsStart(f)).lte('tgl',tsEnd(t));

  const {data:keluar}=await db.from('pengeluaran')
    .select('*').gte('tgl',tsStart(f)).lte('tgl',tsEnd(t));

  const map={};

  // Detail Penjualan
  tableDetail.querySelector('tbody').innerHTML='';
  jual.forEach(r=>{
    const d=r.tgl.split('T')[0];
    map[d]=map[d]||{jual:0,keluar:0};
    map[d].jual+=Number(r.total);

    const row={
      id:r.id,
      tanggal:new Date(r.tgl).toLocaleString(),
      jenis:'Penjualan',
      nama:r.nama_barang,
      jumlah:r.jumlah,
      harga:r.total/r.jumlah,
      total:r.total
    };
    DATA_DETAIL.push(row);

    tableDetail.querySelector('tbody').innerHTML+=`
    <tr>
      <td>${row.tanggal}</td>
      <td>${row.jenis}</td>
      <td>${row.nama}</td>
      <td>${row.jumlah}</td>
      <td>${row.harga}</td>
      <td>${row.total}</td>
      <td><button class="danger" onclick="hapusDetail(${row.id},'penjualan')">Hapus</button></td>
    </tr>`;
  });

  // Detail Pengeluaran
  keluar.forEach(r=>{
    const d=r.tgl.split('T')[0];
    map[d]=map[d]||{jual:0,keluar:0};
    map[d].keluar+=Number(r.jumlah);

    const row={
      id:r.id,
      tanggal:new Date(r.tgl).toLocaleString(),
      jenis:'Pengeluaran',
      nama:r.deskripsi,
      jumlah:'-',
      harga:r.jumlah,
      total:r.jumlah
    };
    DATA_DETAIL.push(row);

    tableDetail.querySelector('tbody').innerHTML+=`
    <tr>
      <td>${row.tanggal}</td>
      <td>${row.jenis}</td>
      <td>${row.nama}</td>
      <td>${row.jumlah}</td>
      <td>${row.harga}</td>
      <td>${row.total}</td>
      <td><button class="danger" onclick="hapusDetail(${row.id},'pengeluaran')">Hapus</button></td>
    </tr>`;
  });

  // Tabel Total
  tableTotal.querySelector('tbody').innerHTML='';
  Object.keys(map).sort().forEach(d=>{
    const row={
      tanggal:d,
      total_penjualan:map[d].jual,
      total_pengeluaran:map[d].keluar,
      subtotal:map[d].jual-map[d].keluar
    };
    DATA_TOTAL.push(row);

    tableTotal.querySelector('tbody').innerHTML+=`
    <tr>
      <td>${row.tanggal}</td>
      <td>${row.total_penjualan}</td>
      <td>${row.total_pengeluaran}</td>
      <td>${row.subtotal}</td>
      <td><button class="danger" onclick="hapusTotal('${row.tanggal}')">Hapus</button></td>
    </tr>`;
  });

  showSpinner(false);
}

function downloadXLS(){
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(DATA_TOTAL),'TOTAL');
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(DATA_DETAIL),'DETAIL');
  XLSX.writeFile(wb,'laporan_penjualan.xls');
}

async function hapusDetail(id,table){
  if(!confirm("Hapus transaksi ini?")) return;
  await db.from(table).delete().eq('id',id);
  loadData();
}

async function hapusTotal(tgl){
  if(!confirm("Hapus semua transaksi tanggal "+tgl+"?")) return;
  // Hapus semua penjualan & pengeluaran tgl tersebut
  await db.from('penjualan').delete().gte('tgl',tgl+"T00:00:00").lte('tgl',tgl+"T23:59:59");
  await db.from('pengeluaran').delete().gte('tgl',tgl+"T00:00:00").lte('tgl',tgl+"T23:59:59");
  loadData();
}

async function hapusTransaksi(type){
  if(!confirm(type==='all'?'Hapus semua data?':'Hapus transaksi > 3 bulan?')) return;
  if(type==='all'){
    await db.from('penjualan').delete().neq('id',0);
    await db.from('pengeluaran').delete().neq('id',0);
  } else {
    const d=new Date(); d.setMonth(d.getMonth()-3);
    await db.from('penjualan').delete().lt('tgl', d.toISOString());
    await db.from('pengeluaran').delete().lt('tgl', d.toISOString());
  }
  loadData();
}

loadData();
</script>
</body>
</html>
