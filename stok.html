<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kelola Stok</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --green:#1fbf75;
  --green-dark:#159c5f;
  --green-soft:#1fbf f1;
  --bg:#31c77c;
  --text:#1f2937;
  --white:#ffffff;
  --shadow:0 10px 25px rgba(0,0,0,.08);
}
*{box-sizing:border-box;font-family:system-ui}
body{background:var(--bg);padding:20px}
.container{max-width:1200px;margin:auto}
.header,.card{
  background:var(--white);
  border-radius:18px;
  box-shadow:var(--shadow);
  padding:24px;
  margin-bottom:20px;
}
.header{text-align:center}
button,input{
  padding:10px 14px;
  border-radius:10px;
  border:none;
  font-size:15px;
}
button{background:var(--green);color:white;cursor:pointer}
button:hover{background:var(--green-dark)}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center}
th{background:var(--green-soft)}
input{background:#ecfeff}
.loading,.modal{
  position:fixed;inset:0;display:none;align-items:center;justify-content:center
}
.loading{background:rgba(255,255,255,.7);z-index:99}
.modal{background:rgba(0,0,0,.4);z-index:100}
.modal-box{
  background:white;padding:24px;border-radius:14px;text-align:center;
  width:90%;max-width:420px
}
.spinner{
  width:48px;height:48px;border:6px solid #d1fae5;
  border-top:6px solid var(--green);border-radius:50%;
  animation:spin 1s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div class="loading" id="loading"><div class="spinner"></div></div>

<div class="modal" id="modal">
  <div class="modal-box">
    <h4 id="modalTitle"></h4>
    <p id="modalMsg"></p>
    <button onclick="closeModal()">Tutup</button>
  </div>
</div>

<div class="container">

<div class="header">
  <h2>Kelola Stok</h2>
  <button onclick="location.href='admin.html'">â¬… Kembali</button>
</div>

<div class="card">
<h3>Tambah Stok</h3>
<input id="namaInput" placeholder="Nama Barang"><br><br>
<input id="hbInput" type="number" placeholder="Harga Beli"><br><br>
<input id="hjInput" type="number" placeholder="Harga Jual"><br><br>
<input id="qtyInput" type="number" placeholder="Jumlah"><br><br>
<button onclick="tambah()">Simpan</button>
</div>

<div class="card">
<h3>Daftar Stok</h3>
<input id="searchStok" placeholder="Cari barang..." oninput="filterStok()" style="margin-bottom:10px;width:100%;padding:8px;border-radius:8px;border:1px solid #ccc">
<table>
<thead>
<tr>
<th>Nama</th><th>Harga Beli</th><th>Harga Jual</th><th>Jumlah</th><th>Aksi</th>
</tr>
</thead>
<tbody id="stokBody"></tbody>
</table>
</div>

</div>

<script>
const SUPABASE_URL="https://fgoeqtyaxwccxluxdvni.supabase.co";
const SUPABASE_ANON_KEY="sb_publishable_ZXJgBsB-sswr7qblwGMnLg_p6QaXKwP";
const db=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const loading=document.getElementById('loading');
const modal=document.getElementById('modal');
const mt=document.getElementById('modalTitle');
const mm=document.getElementById('modalMsg');
const stokBody=document.getElementById('stokBody');
const searchStok=document.getElementById('searchStok');

const elNama=document.getElementById('namaInput');
const elHb=document.getElementById('hbInput');
const elHj=document.getElementById('hjInput');
const elQty=document.getElementById('qtyInput');

function spin(v){loading.style.display=v?'flex':'none'}
function showModal(t,m){mt.textContent=t;mm.textContent=m;modal.style.display='flex'}
function closeModal(){modal.style.display='none'}

async function load(){
spin(true);
const {data}=await db.from('stok').select('*').eq('aktif',true).order('nama_barang');
stokBody.innerHTML='';
(data||[]).forEach(s=>{
stokBody.innerHTML+=`
<tr>
<td><input data-f="nama_barang" data-id="${s.id}" value="${s.nama_barang}"></td>
<td><input data-f="harga_beli" data-id="${s.id}" type="number" value="${s.harga_beli}"></td>
<td><input data-f="harga_jual" data-id="${s.id}" type="number" value="${s.harga_jual}"></td>
<td><input data-f="jumlah" data-id="${s.id}" type="number" value="${s.jumlah}"></td>
<td>
<button onclick="simpan(${s.id})">Simpan</button>
<button onclick="hapus(${s.id})">Hapus</button>
</td>
</tr>`;
});
spin(false);
}

function filterStok(){
  const q = searchStok.value.toLowerCase();
  [...stokBody.querySelectorAll('tr')].forEach(tr=>{
    const nama = tr.querySelector('input[data-f="nama_barang"]').value.toLowerCase();
    tr.style.display = nama.includes(q) ? '' : 'none';
  });
}

async function tambah(){
const namaBarang=elNama.value.trim();
const hb=+elHb.value,hj=+elHj.value,qty=+elQty.value;
if(!namaBarang||hb<=0||hj<=0||qty<=0){
  showModal('Gagal','Data tidak valid');return;
}
spin(true);
const {data}=await db.from('stok')
.insert([{nama_barang:namaBarang,harga_beli:hb,harga_jual:hj,jumlah:qty}])
.select().single();

await db.from('log_stok').insert([{
stok_id:data.id,nama_barang:namaBarang,aksi:'buat',
jumlah_sesudah:qty,harga_beli_sesudah:hb,harga_jual_sesudah:hj
}]);

spin(false);showModal('Sukses','Stok ditambahkan');
elNama.value=elHb.value=elHj.value=elQty.value='';
load();
}

async function simpan(id){
const inputs=[...document.querySelectorAll(`input[data-id='${id}']`)];
let upd={};inputs.forEach(i=>upd[i.dataset.f]=i.type==='number'?+i.value:i.value);
const {data:o}=await db.from('stok').select('*').eq('id',id).single();
spin(true);
await db.from('stok').update(upd).eq('id',id);
await db.from('log_stok').insert([{
stok_id:id,nama_barang:upd.nama_barang,aksi:'edit',
jumlah_sebelum:o.jumlah,jumlah_sesudah:upd.jumlah,
harga_beli_sebelum:o.harga_beli,harga_beli_sesudah:upd.harga_beli,
harga_jual_sebelum:o.harga_jual,harga_jual_sesudah:upd.harga_jual,
nama_lama:o.nama_barang
}]);
spin(false);showModal('Sukses','Stok diperbarui');load();
}

async function hapus(id){
spin(true);
const {data:o}=await db.from('stok').select('*').eq('id',id).single();
await db.from('stok').update({aktif:false}).eq('id',id);
await db.from('log_stok').insert([{
stok_id:null,nama_barang:o.nama_barang,aksi:'hapus',
jumlah_sebelum:o.jumlah,harga_beli_sebelum:o.harga_beli,harga_jual_sebelum:o.harga_jual
}]);
spin(false);showModal('Sukses','Stok dihapus');load();
}

load();
</script>
</body>
</html>
